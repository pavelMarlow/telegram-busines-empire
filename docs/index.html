// ================== –¢–ï–õ–ï–ì–†–ê–ú WEB APP –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==================
const tg = window.Telegram.WebApp;
const app = {
    // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    currentState: {},
    navigationStack: [],
    
    // ================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==================
    init: function() {
        // –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–µ–º Web App –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        tg.expand();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã
        const theme = tg.themeParams;
        document.documentElement.style.setProperty('--bg-color', theme.bg_color || '#212121');
        document.documentElement.style.setProperty('--text-color', theme.text_color || '#ffffff');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        this.loadUserInfo();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        setTimeout(() => {
            this.showScreen('mainMenu');
        }, 1000);
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Telegram
        this.setupTelegramEvents();
    },
    
    // ================== –ó–ê–ì–†–£–ó–ö–ê –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï ==================
    loadUserInfo: function() {
        const user = tg.initDataUnsafe.user;
        const userInfo = document.getElementById('userInfo');
        
        if (user) {
            const userName = user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            userInfo.innerHTML = `
                <div class="user-greeting">
                    üëã –ü—Ä–∏–≤–µ—Ç, ${userName}!
                </div>
            `;
        } else {
            userInfo.innerHTML = `
                <div class="user-greeting">
                    üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!
                </div>
            `;
        }
    },
    
    // ================== –ù–ê–°–¢–†–û–ô–ö–ê –°–û–ë–´–¢–ò–ô TELEGRAM ==================
    setupTelegramEvents: function() {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
        tg.onEvent('themeChanged', () => {
            const theme = tg.themeParams;
            document.documentElement.style.setProperty('--bg-color', theme.bg_color || '#212121');
            document.documentElement.style.setProperty('--text-color', theme.text_color || '#ffffff');
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞
        tg.onEvent('webAppDataReceived', (event) => {
            console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –æ—Ç –±–æ—Ç–∞:', event);
        });
    },
    
    // ================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê–ú–ò ==================
    showScreen: function(screenId) {
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
        const screens = document.querySelectorAll('.screen');
        screens.forEach(screen => {
            if (screen.id !== 'loadingScreen') {
                screen.classList.add('hidden');
            }
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–ª–µ–≤–æ–π —ç–∫—Ä–∞–Ω
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
            targetScreen.classList.remove('hidden');
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å—Ç–µ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        if (screenId !== 'loadingScreen') {
            this.navigationStack.push(screenId);
        }
    },
    
    backToPrevious: function() {
        if (this.navigationStack.length > 1) {
            this.navigationStack.pop(); // –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–∏–π —ç–∫—Ä–∞–Ω
            const previousScreen = this.navigationStack[this.navigationStack.length - 1];
            this.showScreen(previousScreen);
        } else {
            this.backToMain();
        }
    },
    
    backToMain: function() {
        this.navigationStack = ['mainMenu'];
        this.showScreen('mainMenu');
    },
    
    // ================== –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ==================
    showUnlockMenu: function() {
        this.currentState.orderType = 'unlock';
        this.showScreen('unlockMenu');
    },
    
    showKeyMenu: function() {
        this.currentState.orderType = 'access_key';
        this.showScreen('durationScreen');
    },
    
    openSupport: function() {
        tg.openTelegramLink('https://t.me/your_support_bot');
    },
    
    showMyOrders: function() {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
        // –î–ª—è –¥–µ–º–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–∫–∞–∑—ã
        const ordersList = document.getElementById('ordersList');
        ordersList.innerHTML = `
            <div class="order-card">
                <div class="order-header">
                    <div class="order-id">–ó–∞–∫–∞–∑ #1001</div>
                    <div class="order-status status-paid">–û–ø–ª–∞—á–µ–Ω</div>
                </div>
                <div class="order-details">
                    <div>üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ iPhone 14</div>
                    <div>–°—É–º–º–∞: 15 000 ‚ÇΩ</div>
                    <div>–î–∞—Ç–∞: 25.12.2023</div>
                </div>
            </div>
            
            <div class="order-card">
                <div class="order-header">
                    <div class="order-id">–ó–∞–∫–∞–∑ #1002</div>
                    <div class="order-status status-paid">–û–ø–ª–∞—á–µ–Ω</div>
                </div>
                <div class="order-details">
                    <div>üîë –ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞ (–ú–µ—Å—è—Ü)</div>
                    <div>–°—É–º–º–∞: 8 000 ‚ÇΩ</div>
                    <div>–î–∞—Ç–∞: 20.12.2023</div>
                    <div class="order-key">XXXX-XXXX-XXXX-XXXX</div>
                </div>
            </div>
            
            <div class="order-card">
                <div class="order-header">
                    <div class="order-id">–ó–∞–∫–∞–∑ #1003</div>
                    <div class="order-status status-pending">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</div>
                </div>
                <div class="order-details">
                    <div>üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ iPad Pro</div>
                    <div>–°—É–º–º–∞: 20 000 ‚ÇΩ</div>
                    <div>–î–∞—Ç–∞: 26.12.2023</div>
                </div>
            </div>
        `;
        this.showScreen('ordersScreen');
    },
    
    showInfo: function() {
        this.showScreen('infoScreen');
    },
    
    // ================== –í–´–ë–û–† –£–°–¢–†–û–ô–°–¢–í–ê ==================
    selectDeviceType: function(deviceType) {
        this.currentState.deviceType = deviceType;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const title = document.getElementById('deviceListTitle');
        title.textContent = deviceType === 'iphone' ? 'üì± iPhone' : 'üíª iPad';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        this.loadDevices(deviceType);
        this.showScreen('deviceListScreen');
    },
    
    loadDevices: function(deviceType) {
        const deviceList = document.getElementById('deviceList');
        deviceList.innerHTML = '';
        
        // –î–µ–º–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ - –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞
        let devices = [];
        
        if (deviceType === 'iphone') {
            devices = [
                { id: 1, model: 'iPhone 5', basePrice: 3000 },
                { id: 2, model: 'iPhone 6', basePrice: 4500 },
                { id: 3, model: 'iPhone 7', basePrice: 6000 },
                { id: 4, model: 'iPhone 8', basePrice: 7500 },
                { id: 5, model: 'iPhone X', basePrice: 9000 },
                { id: 6, model: 'iPhone 11', basePrice: 10500 },
                { id: 7, model: 'iPhone 12', basePrice: 12000 },
                { id: 8, model: 'iPhone 13', basePrice: 13500 },
                { id: 9, model: 'iPhone 14', basePrice: 15000 },
                { id: 10, model: 'iPhone 15', basePrice: 16500 }
            ];
        } else {
            devices = [
                { id: 11, model: 'iPad Air 2', basePrice: 5000 },
                { id: 12, model: 'iPad 6th Gen', basePrice: 6500 },
                { id: 13, model: 'iPad 7th Gen', basePrice: 8000 },
                { id: 14, model: 'iPad 8th Gen', basePrice: 9500 },
                { id: 15, model: 'iPad 9th Gen', basePrice: 11000 },
                { id: 16, model: 'iPad 10th Gen', basePrice: 12500 }
            ];
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–µ–π—Å—è —Ü–µ–Ω–æ–π
        devices.forEach((device, index) => {
            const price = device.basePrice + (index * 1500);
            const deviceElement = document.createElement('div');
            deviceElement.className = 'device-item';
            deviceElement.innerHTML = `
                <div class="device-name">${device.model}</div>
                <div class="device-price">${price.toLocaleString()} ‚ÇΩ</div>
            `;
            deviceElement.onclick = () => this.selectDevice(device.model, price, device.id);
            deviceList.appendChild(deviceElement);
        });
    },
    
    selectDevice: function(model, price, deviceId) {
        this.currentState.deviceModel = model;
        this.currentState.deviceId = deviceId;
        this.currentState.amount = price;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–¥–∫—É –∑–∞–∫–∞–∑–∞
        this.showOrderSummary();
        this.showScreen('paymentScreen');
    },
    
    backToUnlockMenu: function() {
        this.showScreen('unlockMenu');
    },
    
    // ================== –í–´–ë–û–† –î–õ–ò–¢–ï–õ–¨–ù–û–°–¢–ò ==================
    selectDuration: function(duration, price) {
        this.currentState.duration = duration;
        this.currentState.amount = price;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–¥–∫—É –∑–∞–∫–∞–∑–∞
        this.showOrderSummary();
        this.showScreen('paymentScreen');
    },
    
    // ================== –°–í–û–î–ö–ê –ó–ê–ö–ê–ó–ê ==================
    showOrderSummary: function() {
        const orderSummary = document.getElementById('orderSummary');
        
        if (this.currentState.orderType === 'unlock') {
            orderSummary.innerHTML = `
                <h3>–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞:</h3>
                <div class="order-detail">
                    <span>–£—Å–ª—É–≥–∞:</span>
                    <span>üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞</span>
                </div>
                <div class="order-detail">
                    <span>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</span>
                    <span>${this.currentState.deviceModel}</span>
                </div>
                <div class="order-detail">
                    <span>–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                    <span>${this.currentState.amount.toLocaleString()} ‚ÇΩ</span>
                </div>
                <div class="order-total">
                    –ò—Ç–æ–≥–æ: ${this.currentState.amount.toLocaleString()} ‚ÇΩ
                </div>
            `;
        } else {
            const durationText = this.currentState.duration.replace('_', ' ');
            orderSummary.innerHTML = `
                <h3>–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞:</h3>
                <div class="order-detail">
                    <span>–£—Å–ª—É–≥–∞:</span>
                    <span>üîë –ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞</span>
                </div>
                <div class="order-detail">
                    <span>–°—Ä–æ–∫:</span>
                    <span>${durationText}</span>
                </div>
                <div class="order-detail">
                    <span>–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                    <span>${this.currentState.amount.toLocaleString()} ‚ÇΩ</span>
                </div>
                <div class="order-total">
                    –ò—Ç–æ–≥–æ: ${this.currentState.amount.toLocaleString()} ‚ÇΩ
                </div>
            `;
        }
    },
    
    // ================== –í–´–ë–û–† –û–ü–õ–ê–¢–´ ==================
    selectPayment: function(paymentMethod) {
        this.currentState.paymentMethod = paymentMethod;
        
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
        // –î–ª—è –¥–µ–º–æ –∏–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂
        this.simulatePayment();
    },
    
    simulatePayment: function() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        const successMessage = document.getElementById('successMessage');
        
        if (this.currentState.orderType === 'unlock') {
            successMessage.innerHTML = `
                ‚úÖ <strong>–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!</strong><br><br>
                üë®‚Äçüíª –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∫–æ—Ä–æ –≤–∞–º –æ—Ç–≤–µ—Ç–∏—Ç.<br>
                ‚è± –û—Ç–≤–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 10-50 –º–∏–Ω—É—Ç.<br><br>
                –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: #${Math.floor(1000 + Math.random() * 9000)}
            `;
        } else {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–µ–º–æ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞
            const accessKey = this.generateAccessKey();
            successMessage.innerHTML = `
                ‚úÖ <strong>–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!</strong><br><br>
                –í–∞—à –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞:<br>
                <strong>${accessKey}</strong><br><br>
                ‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∫–ª—é—á –≤ –Ω–∞–¥–µ–∂–Ω–æ–º –º–µ—Å—Ç–µ!<br>
                –û–Ω –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω.
            `;
        }
        
        this.showScreen('successScreen');
    },
    
    generateAccessKey: function() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let key = '';
        
        for (let i = 0; i < 4; i++) {
            for (let j = 0; j < 4; j++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            if (i < 3) key += '-';
        }
        
        return key;
    },
    
    // ================== –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –ë–û–¢–£ ==================
    sendDataToBot: function(data) {
        tg.sendData(JSON.stringify(data));
    }
};

// ================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´ ==================
document.addEventListener('DOMContentLoaded', function() {
    app.init();
});

// ================== TELEGRAM WEB APP READY ==================
tg.ready();
